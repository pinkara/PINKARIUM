<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Atelier Game of Life ‚Äî PINKARIUM</title>
    <!-- Favicon -->
    <link rel="icon" href="https://pinkara.github.io/PINKARIUM/favicon/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="https://pinkara.github.io/PINKARIUM/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://pinkara.github.io/PINKARIUM/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://pinkara.github.io/PINKARIUM/favicon/favicon-48x48.png" sizes="48x48">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/png" href="https://pinkara.github.io/PINKARIUM/favicon/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="https://pinkara.github.io/PINKARIUM/favicon/android-chrome-512x512.png" sizes="512x512">
    <link rel="apple-touch-icon" href="https://pinkara.github.io/PINKARIUM/favicon/apple-touch-icon.png">
    <link rel="mask-icon" href="https://pinkara.github.io/PINKARIUM/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="icon" href="https://pinkara.github.io/PINKARIUM/favicon/favicon.svg" type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Prism -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* =========================
           TH√àME TOKYO NIGHT
           ========================= */
        :root {
            --tn-bg: #1a1b26;
            --tn-bg-2: #24283b;
            --tn-fg: #c0caf5;
            --tn-accent: #7aa2f7; /* Bleu */
            --tn-cyan: #7dcfff;
            --tn-green: #9ece6a; /* Vert Life */
            --tn-orange: #ff9e64;
            --tn-magenta: #bb9af7;
            --tn-red: #f7768e;
            --tn-border: #414868;
            --tn-comment: #565f89;
            --tn-grid-line: rgba(255, 255, 255, 0.08); /* Couleur subtile de la grille */
        }

        body {
            background-color: var(--tn-bg);
            color: var(--tn-fg);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }
        
        .canvas-area {
            flex: 1;
            position: relative;
            background: #16161e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-right: 1px solid var(--tn-border);
            cursor: crosshair;
        }

        .sidebar {
            width: 420px;
            background: var(--tn-bg-2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
            z-index: 10;
            flex-shrink: 0;
        }

        /* --- HEADER & TABS --- */
        .header-box {
            padding: 16px;
            border-bottom: 1px solid var(--tn-border);
            background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
        }
        .header-title { font-weight: 800; font-size: 1.1rem; color: var(--tn-fg); }
        .header-subtitle { font-size: 0.75rem; color: var(--tn-green); opacity: 0.9; margin-top: 2px; }

        .logo-box {
            width: 40px; height: 40px; 
            /* D√©grad√© Vert pour matcher les cellules */
            background: linear-gradient(135deg, var(--tn-green), #73daca); 
            border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; color: #1a1b26; font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(158, 206, 106, 0.2);
        }

        .tabs { display: flex; background: rgba(0,0,0,0.2); gap: 1px; }
        .tab-btn {
            flex: 1; padding: 12px; background: var(--tn-bg-2); border: none;
            border-bottom: 2px solid transparent; color: var(--tn-comment);
            cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--tn-fg); background: rgba(255,255,255,0.02); }
        .tab-btn.active { color: var(--tn-green); border-bottom-color: var(--tn-green); background: rgba(158, 206, 106, 0.05); }

        /* --- PANELS --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 0; }
        .panel { display: none; padding: 16px; animation: fadeIn 0.3s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CONTROLS --- */
        .control-group {
            background: rgba(0,0,0,0.2); border: 1px solid var(--tn-border);
            padding: 14px; border-radius: 8px; margin-bottom: 14px;
        }
        .control-header {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--tn-magenta); margin-bottom: 10px; font-weight: 700; display: flex; justify-content: space-between; align-items: center;
        }

        label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: var(--tn-fg); margin-top: 10px; }
        
        input[type="range"] {
            width: 100%; accent-color: var(--tn-green); height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer;
        }
        select, button.btn-secondary {
            width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.3); 
            border: 1px solid var(--tn-border); border-radius: 6px;
            color: var(--tn-green); font-family: 'Inter', sans-serif; font-size: 0.9rem;
            cursor: pointer; transition: 0.2s; text-align: left;
        }
        button.btn-secondary:hover { border-color: var(--tn-green); background: rgba(158, 206, 106, 0.05); }

        /* Action Buttons */
        .action-btn {
            width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px;
            border: none; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-play { background: var(--tn-green); color: #1a1b26; }
        .btn-play:hover { background: #b9f27c; box-shadow: 0 0 15px rgba(158, 206, 106, 0.3); }
        .btn-pause { background: var(--tn-orange); color: #1a1b26; }
        .btn-pause:hover { background: #ffb57d; }
        .btn-clear { background: var(--tn-red); color: #1a1b26; opacity: 0.8; margin-top: 6px;}
        .btn-clear:hover { opacity: 1; }

        /* Stats */
        .stat-row { display: flex; justify-content: space-between; font-family: 'JetBrains Mono'; font-size: 0.8rem; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px;}
        .stat-val { color: var(--tn-green); font-weight: bold; }

        /* Presets Grid */
        .presets-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
        .preset-btn { 
            padding: 8px; border: 1px solid var(--tn-border); border-radius: 4px; 
            background: rgba(255,255,255,0.02); color: var(--tn-fg); font-size: 0.75rem; cursor: pointer; text-align: center;
            transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .preset-btn:hover { background: var(--tn-green); color: var(--tn-bg); border-color: var(--tn-green); transform: translateY(-1px); }
        .preset-category { grid-column: span 2; font-size: 0.7rem; color: var(--tn-comment); margin-top: 8px; margin-bottom: 2px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; }

        /* Code & Math */
        .formula-box {
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;
            border-left: 3px solid var(--tn-green); margin-bottom: 12px; font-size: 0.9rem;
        }
        pre { margin: 0 !important; border-radius: 6px; font-size: 0.8rem !important; border: 1px solid var(--tn-border); background: #16161e !important; }

        /* Canvas Overlay */
        .canvas-overlay {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(26, 27, 38, 0.8); backdrop-filter: blur(4px);
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--tn-border);
            pointer-events: none; font-size: 0.75rem; color: var(--tn-comment);
        }

        @media (max-width: 900px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 50%; }
            .canvas-area { height: 50%; border-right: none; border-bottom: 1px solid var(--tn-border); }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- CANVAS AREA -->
    <div class="canvas-area" id="canvas-container">
        <canvas id="gameCanvas"></canvas>
        <div class="canvas-overlay">
            <span style="color:var(--tn-green)">Clic gauche</span> : Dessiner/Effacer<br>
            <span style="color:var(--tn-green)">Espace</span> : Pause/Play
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="header-box">
            <div style="display: flex; gap: 12px; align-items: center;">
                <div class="logo-box">GoL</div>
                <div>
                    <div class="header-title">Game of Life</div>
                    <div class="header-subtitle">Style & Grille</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('lab')">Labo</button>
            <button class="tab-btn" onclick="setTab('theory')">Th√©orie</button>
            <button class="tab-btn" onclick="setTab('code')">Python</button>
        </div>

        <div class="content-scroll">
            
            <!-- ONGLET LABO -->
            <div id="panel-lab" class="panel active">
                
                <!-- Contr√¥les -->
                <div class="control-group">
                    <div class="control-header">üéÆ Simulation</div>
                    <button id="btn-toggle" class="action-btn btn-play" onclick="togglePlay()">
                        <span>‚ñ∂ D√âMARRER</span>
                    </button>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <button class="btn-secondary" onclick="step()">PAS √Ä PAS ‚ûù</button>
                        <button class="btn-secondary" onclick="randomizeGrid()">AL√âATOIRE üé≤</button>
                    </div>
                     <button class="action-btn btn-clear" onclick="clearGrid()">EFFACER LA GRILLE</button>
                </div>

                <!-- Patterns -->
                <div class="control-group">
                    <div class="control-header">üß© Biblioth√®que</div>
                    
                    <div class="presets-grid">
                        <div class="preset-category" style="margin-top:0;">Vaisseaux</div>
                        <div class="preset-btn" onclick="loadPreset('glider')">Glider<br><span style="font-size:0.6rem; opacity:0.6">Le classique</span></div>
                        <div class="preset-btn" onclick="loadPreset('lwss')">LWSS<br><span style="font-size:0.6rem; opacity:0.6">L√©ger</span></div>
                        <div class="preset-btn" onclick="loadPreset('mwss')">MWSS<br><span style="font-size:0.6rem; opacity:0.6">Moyen</span></div>
                        <div class="preset-btn" onclick="loadPreset('hwss')">HWSS<br><span style="font-size:0.6rem; opacity:0.6">Lourd</span></div>

                        <div class="preset-category">Oscillateurs & Canons</div>
                        <div class="preset-btn" onclick="loadPreset('pulsar')">Pulsar<br><span style="font-size:0.6rem; opacity:0.6">P√©riode 3</span></div>
                        <div class="preset-btn" onclick="loadPreset('penta')">Penta-decathlon<br><span style="font-size:0.6rem; opacity:0.6">P√©riode 15</span></div>
                        <div class="preset-btn" style="grid-column: span 2;" onclick="loadPreset('gosper')">Gosper Glider Gun<br><span style="font-size:0.6rem; opacity:0.6">Premier canon d√©couvert (1970)</span></div>

                        <div class="preset-category">Chaos & Mathusalem</div>
                        <div class="preset-btn" onclick="loadPreset('rpent')">R-Pentomino<br><span style="font-size:0.6rem; opacity:0.6">5 cellules, chaos total</span></div>
                        <div class="preset-btn" onclick="loadPreset('diehard')">Diehard<br><span style="font-size:0.6rem; opacity:0.6">Disparait apr√®s 130 g√©n.</span></div>
                        <div class="preset-btn" onclick="loadPreset('acorn')">Acorn<br><span style="font-size:0.6rem; opacity:0.6">Explosion massive</span></div>
                        <div class="preset-btn" onclick="loadPreset('line')">Infinite Line<br><span style="font-size:0.6rem; opacity:0.6">Complexit√© √©mergente</span></div>
                    </div>
                </div>

                <!-- Param√®tres -->
                <div class="control-group">
                    <div class="control-header">‚öôÔ∏è R√©glages</div>
                    <label>Vitesse <span id="speed-val" style="float:right; color:var(--tn-cyan)">50 ms</span></label>
                    <input type="range" min="10" max="500" step="10" value="50" oninput="updateSpeed(this.value)">
                    <label>Zoom (Taille Cellule)</label>
                    <select id="cell-size-select" onchange="updateCellSize(this.value)">
                        <option value="6">Petit (6px)</option>
                        <option value="12" selected>Moyen (12px)</option>
                        <option value="20">Grand (20px)</option>
                    </select>
                </div>

                <!-- Stats -->
                <div class="control-group">
                    <div class="control-header">üìä Statistiques</div>
                    <div class="stat-row">
                        <span>G√©n√©ration :</span>
                        <span id="stat-gen" class="stat-val">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Population :</span>
                        <span id="stat-pop" class="stat-val">0</span>
                    </div>
                </div>
            </div>

            <!-- ONGLET TH√âORIE -->
            <div id="panel-theory" class="panel">
                <h2 class="text-xl font-bold text-gray-200 mb-4">La Faune du Jeu</h2>
                
                <div class="formula-box" style="border-left-color: var(--tn-green);">
                    <strong style="color:var(--tn-green)">Vaisseaux (Spaceships)</strong>
                    <p class="mt-1">Structures qui se d√©placent sur la grille. Le "Glider" est le plus petit. Les LWSS, MWSS et HWSS sont des vaisseaux plus complexes qui se d√©placent horizontalement.</p>
                </div>

                <div class="formula-box" style="border-left-color: var(--tn-magenta);">
                    <strong style="color:var(--tn-magenta)">Oscillateurs</strong>
                    <p class="mt-1">Structures qui reviennent √† leur √©tat initial apr√®s un nombre fixe de g√©n√©rations (p√©riode). Le "Pulsar" a une p√©riode de 3, le "Penta-decathlon" de 15.</p>
                </div>

                <div class="formula-box" style="border-left-color: var(--tn-orange);">
                    <strong style="color:var(--tn-orange)">Mathusalems</strong>
                    <p class="mt-1">Petits motifs initiaux (comme le R-pentomino) qui mettent tr√®s longtemps √† se stabiliser, cr√©ant un chaos apparent avant de finir en structures stables ou oscillateurs.</p>
                </div>

                <h3 class="font-bold text-gray-300 mt-6 mb-2">Rappel des R√®gles (B3/S23)</h3>
                <ul class="list-disc pl-5 space-y-2 text-sm text-gray-400">
                    <li><span style="color:var(--tn-red)">Mort</span> si < 2 ou > 3 voisins.</li>
                    <li><span style="color:var(--tn-green)">Survie</span> si 2 ou 3 voisins.</li>
                    <li><span style="color:var(--tn-cyan)">Naissance</span> si exactement 3 voisins.</li>
                </ul>
            </div>

            <!-- ONGLET CODE -->
            <div id="panel-code" class="panel">
                <h2 class="text-xl font-bold text-gray-200 mb-4">Impl√©mentation Python</h2>
                <p class="text-sm text-gray-400 mb-4">Code optimis√© utilisant NumPy pour calculer les voisins.</p>
                
                <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation

def update(grid):
    # Copie pour le calcul
    new_grid = grid.copy()
    rows, cols = grid.shape
    
    for r in range(rows):
        for c in range(cols):
            # Calcul somme voisins (tore)
            # Utilise modulo % pour les bords
            total = (grid[(r-1)%rows, (c-1)%cols] + grid[(r-1)%rows, c] + 
                     grid[(r-1)%rows, (c+1)%cols] + grid[r, (c-1)%cols] + 
                     grid[r, (c+1)%cols] + grid[(r+1)%rows, (c-1)%cols] + 
                     grid[(r+1)%rows, c] + grid[(r+1)%rows, (c+1)%cols])
            
            # R√®gles B3/S23
            if grid[r, c] == 1:
                if (total < 2) or (total > 3):
                    new_grid[r, c] = 0
            else:
                if total == 3:
                    new_grid[r, c] = 1
                    
    return new_grid

# Note: Pour une performance maximale, on utiliserait
# scipy.signal.convolve2d au lieu de boucles for.</code></pre>
            </div>

        </div>
    </div>
</div>

<script>
// --- CONFIGURATION CANVAS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const container = document.getElementById('canvas-container');

// √âtats
let isPlaying = false;
let animationId = null;
let lastFrameTime = 0;
let updateInterval = 50;

let cellSize = 12; // Un peu plus grand par d√©faut
let rows = 0;
let cols = 0;
let grid = [];
let nextGrid = [];
let generation = 0;

// Couleurs V3
const COLOR_BG = '#16161e';
const COLOR_ALIVE = '#9ece6a'; // Vert Tokyo Night (plus "Life")
const COLOR_GRID = 'rgba(255, 255, 255, 0.08)'; // Grille subtile

// --- MOTEUR ---

function resizeCanvas() {
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    
    const oldRows = rows;
    const oldCols = cols;
    const oldGrid = grid;

    cols = Math.ceil(canvas.width / cellSize);
    rows = Math.ceil(canvas.height / cellSize);

    grid = new Uint8Array(rows * cols);
    nextGrid = new Uint8Array(rows * cols);

    // Centrage de l'ancien contenu si redimensionnement
    if (oldRows > 0) {
        const dr = Math.floor((rows - oldRows) / 2);
        const dc = Math.floor((cols - oldCols) / 2);
        
        for(let r=0; r<oldRows; r++) {
            for(let c=0; c<oldCols; c++) {
                if(oldGrid[r*oldCols+c]) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if(nr>=0 && nr<rows && nc>=0 && nc<cols) {
                        grid[nr*cols+nc] = 1;
                    }
                }
            }
        }
    } else {
        // Init: LWSS au centre pour la d√©mo
        const cr = Math.floor(rows/2);
        const cc = Math.floor(cols/2);
        loadPreset('glider'); // Charge un petit glider par d√©faut
    }
    draw();
}

function initRandom() {
    for (let i = 0; i < grid.length; i++) {
        grid[i] = Math.random() < 0.2 ? 1 : 0;
    }
    generation = 0;
    updateStats();
}

function clearGrid() {
    grid.fill(0);
    generation = 0;
    updateStats();
    draw();
}

function getIndex(r, c) {
    const rWrapped = (r + rows) % rows;
    const cWrapped = (c + cols) % cols;
    return rWrapped * cols + cWrapped;
}

function computeNextGen() {
    let activeCount = 0;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const idx = r * cols + c;
            
            // Somme des 8 voisins (optimis√©e)
            let n = 0;
            // Voisins directs
            const rMinus = (r - 1 + rows) % rows;
            const rPlus = (r + 1) % rows;
            const cMinus = (c - 1 + cols) % cols;
            const cPlus = (c + 1) % cols;
            
            n += grid[rMinus * cols + cMinus];
            n += grid[rMinus * cols + c];
            n += grid[rMinus * cols + cPlus];
            n += grid[r * cols + cMinus];
            n += grid[r * cols + cPlus];
            n += grid[rPlus * cols + cMinus];
            n += grid[rPlus * cols + c];
            n += grid[rPlus * cols + cPlus];

            const cell = grid[idx];
            
            if (cell === 1) {
                if (n === 2 || n === 3) {
                    nextGrid[idx] = 1;
                    activeCount++;
                } else {
                    nextGrid[idx] = 0;
                }
            } else {
                if (n === 3) {
                    nextGrid[idx] = 1;
                    activeCount++;
                } else {
                    nextGrid[idx] = 0;
                }
            }
        }
    }

    // Swap buffers
    let temp = grid;
    grid = nextGrid;
    nextGrid = temp;
    
    generation++;
    updateStats(activeCount);
}

function draw() {
    // 1. Fond
    ctx.fillStyle = COLOR_BG;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 2. Grille (Optimis√©e : dessiner des lignes longues au lieu de rects)
    ctx.beginPath();
    ctx.strokeStyle = COLOR_GRID;
    ctx.lineWidth = 1;

    // Lignes verticales
    for (let c = 0; c <= cols; c++) {
        const x = c * cellSize;
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
    }
    // Lignes horizontales
    for (let r = 0; r <= rows; r++) {
        const y = r * cellSize;
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
    }
    ctx.stroke();

    // 3. Cellules Vivantes
    ctx.fillStyle = COLOR_ALIVE;
    // Petit padding pour que la cellule ne recouvre pas totalement la grille (optionnel, 
    // mais ici on remplit la case, la grille √©tant dessin√©e avant, elle sera couverte par la cellule.
    // Si on veut voir la grille AUTOUR des cellules, on r√©duit l√©g√®rement la taille de la cellule).
    const gap = 1; 

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            if (grid[r * cols + c] === 1) {
                // On laisse 1px de marge pour voir la s√©paration
                ctx.fillRect(c * cellSize + gap, r * cellSize + gap, cellSize - gap*2, cellSize - gap*2);
            }
        }
    }
}

function gameLoop(timestamp) {
    if (!isPlaying) return;
    if (timestamp - lastFrameTime > updateInterval) {
        computeNextGen();
        draw();
        lastFrameTime = timestamp;
    }
    animationId = requestAnimationFrame(gameLoop);
}

// --- UI INTERACTIONS ---

function togglePlay() {
    isPlaying = !isPlaying;
    const btn = document.getElementById('btn-toggle');
    if (isPlaying) {
        btn.innerHTML = '<span>‚è∏ PAUSE</span>';
        btn.classList.remove('btn-play');
        btn.classList.add('btn-pause');
        lastFrameTime = performance.now();
        gameLoop(lastFrameTime);
    } else {
        btn.innerHTML = '<span>‚ñ∂ D√âMARRER</span>';
        btn.classList.remove('btn-pause');
        btn.classList.add('btn-play');
        cancelAnimationFrame(animationId);
    }
}

function step() {
    if (isPlaying) togglePlay();
    computeNextGen();
    draw();
}

function updateSpeed(val) {
    updateInterval = parseInt(val);
    document.getElementById('speed-val').innerText = val + ' ms';
}

function updateCellSize(val) {
    cellSize = parseInt(val);
    resizeCanvas();
}

function randomizeGrid() {
    initRandom();
    draw();
}

function updateStats(pop = -1) {
    document.getElementById('stat-gen').innerText = generation;
    if (pop === -1) {
        pop = 0;
        for(let i=0; i<grid.length; i++) if(grid[i]) pop++;
    }
    document.getElementById('stat-pop').innerText = pop;
}

function setTab(id) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('panel-'+id).classList.add('active');
    document.querySelector(`.tab-btn[onclick="setTab('${id}')"]`).classList.add('active');
}

// --- INTERACTION SOURIS ---

let isDrawing = false;
let drawMode = 1;

function getGridCoords(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    return { 
        c: Math.floor(x / cellSize), 
        r: Math.floor(y / cellSize) 
    };
}

canvas.addEventListener('mousedown', (e) => {
    isDrawing = true;
    const { r, c } = getGridCoords(e);
    if (r >= 0 && r < rows && c >= 0 && c < cols) {
        drawMode = grid[r * cols + c] ? 0 : 1;
        grid[r * cols + c] = drawMode;
        draw();
    }
});

canvas.addEventListener('mousemove', (e) => {
    if (!isDrawing) return;
    const { r, c } = getGridCoords(e);
    if (r >= 0 && r < rows && c >= 0 && c < cols) {
        if (grid[r * cols + c] !== drawMode) {
            grid[r * cols + c] = drawMode;
            draw();
        }
    }
});

window.addEventListener('mouseup', () => { isDrawing = false; });
canvas.addEventListener('mouseleave', () => { isDrawing = false; });

window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        togglePlay();
    }
});

window.addEventListener('resize', () => {
    clearTimeout(window.resizeTimer);
    window.resizeTimer = setTimeout(resizeCanvas, 100);
});

// --- BIBLIOTH√àQUE DE PATTERNS ---

const PRESETS = {
    glider: [[0,1], [1,2], [2,0], [2,1], [2,2]], 
    
    // Vaisseaux (Correction appliqu√©e)
    lwss: [
        [0,1], [0,4],
        [1,0],
        [2,0], [2,4],
        [3,0], [3,1], [3,2], [3,3]
    ],
    mwss: [
        [0,1], [0,5],
        [1,0],
        [2,0], [2,5],
        [3,0], [3,1], [3,2], [3,3], [3,4]
    ],
    hwss: [
        [0,1], [0,6],
        [1,0],
        [2,0], [2,6],
        [3,0], [3,1], [3,2], [3,3], [3,4], [3,5]
    ],
    
    // Oscillateurs
    pulsar: [ 
        [2,4], [2,5], [2,6], [2,10], [2,11], [2,12],
        [4,2], [4,7], [4,9], [4,14],
        [5,2], [5,7], [5,9], [5,14],
        [6,2], [6,7], [6,9], [6,14],
        [7,4], [7,5], [7,6], [7,10], [7,11], [7,12],
        [9,4], [9,5], [9,6], [9,10], [9,11], [9,12],
        [10,2], [10,7], [10,9], [10,14],
        [11,2], [11,7], [11,9], [11,14],
        [12,2], [12,7], [12,9], [12,14],
        [14,4], [14,5], [14,6], [14,10], [14,11], [14,12]
    ],
    
    // Penta-decathlon
    penta: [[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6], [0,7], [0,8], [0,9]],

    // Canons
    gosper: [
        [5,1], [5,2], [6,1], [6,2],
        [5,11], [6,11], [7,11], [4,12], [8,12], [3,13], [9,13], [3,14], [9,14], [6,15], [4,16], [8,16], [5,17], [6,17], [7,17], [6,18],
        [3,21], [4,21], [5,21], [3,22], [4,22], [5,22], [2,23], [6,23], [1,25], [2,25], [6,25], [7,25],
        [3,35], [4,35], [3,36], [4,36]
    ],

    // Chaos
    diehard: [[0,6], [1,0], [1,1], [2,1], [2,5], [2,6], [2,7]],
    acorn: [[0,1], [1,3], [2,0], [2,1], [2,4], [2,5], [2,6]],
    rpent: [[0,1], [0,2], [1,0], [1,1], [2,1]], 
    line: Array.from({length: 40}, (_, i) => [0, i]) 
};

function loadPreset(name) {
    if (isPlaying) togglePlay();
    clearGrid();
    
    const pattern = PRESETS[name];
    if (!pattern) return;

    const centerR = Math.floor(rows / 2);
    const centerC = Math.floor(cols / 2);

    pattern.forEach(([r, c]) => {
        const tr = centerR + r - 2; 
        const tc = centerC + c - 2;
        if (tr >= 0 && tr < rows && tc >= 0 && tc < cols) {
            grid[tr * cols + tc] = 1;
        }
    });
    
    updateStats();
    draw();
}

// Start
resizeCanvas();

</script>
</body>
</html>
